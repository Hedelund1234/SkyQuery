services:
  redis:
    image: redis:7
    restart: unless-stopped

  appgateway:
    build:
      context: .
      dockerfile: SkyQuery.AppGateway/Dockerfile
    image: appgateway-image
    #container_name: appgateway-container
    env_file:
      - ./SkyQuery.AppGateway/.env
    environment:
      - ASPNETCORE_URLS=http://:8080 # App lytter p√• 8080 inde i containeren
    ports:
      - "8010:8080" # ekstern adgang: http://HOST:8010          
    depends_on:
      - authservice
      - imageservice
    volumes:
      - skyquery-images:/data/images
    restart: unless-stopped

  appgateway-dapr:
    image: daprio/daprd:1.13.5
    command: ["./daprd",
      "-app-id","skyquery-appgateway-dapr",
      "-app-port","8080",
      "-components-path","/components"]
    volumes:
      - ./:/components:ro
    network_mode: "service:appgateway"
    depends_on:
      - appgateway
    restart: unless-stopped

  authservice:
    build:
      context: .
      dockerfile: SkyQuery.AuthService/Dockerfile
    image: authservice-image
    #container_name: authservice-container
    env_file:
      - ./SkyQuery.AuthService/.env
    environment:
      - ASPNETCORE_URLS=http://+:8081
    restart: unless-stopped

  authservice-dapr:
    image: daprio/daprd:1.13.5
    command: ["./daprd",
      "-app-id","skyquery-authservice-dapr",
      "-app-port","8081",
      "-components-path","/components"]
    volumes:
      - ./:/components:ro
    network_mode: "service:authservice"
    depends_on:
      - authservice
    restart: unless-stopped

  imageservice:
    build:
      context: .
      dockerfile: SkyQuery.ImageService/Dockerfile
    image: imageservice-image
    #container_name: imageservice-container
    env_file:
      - ./SkyQuery.ImageService/.env
    environment:
      - ASPNETCORE_URLS=http://+:8082
    restart: unless-stopped

  imageservice-dapr:
    image: daprio/daprd:1.13.5
    command: ["./daprd",
      "-app-id","skyquery-imageservice-dapr",
      "-app-port","8082",
      "-components-path","/components"]
    volumes:
      - ./:/components:ro
    network_mode: "service:imageservice"
    depends_on:
      - imageservice
    restart: unless-stopped

volumes:
  skyquery-images: