@page "/mgrs-kort"
@using System.Collections.Generic

<PageTitle>MGRS Danmarkskort</PageTitle>

<div class="page-header">
    <h1>Interaktivt MGRS-kort over Danmark</h1>
    <p class="lead">
        Kortet er opdelt i 5x5 km MGRS-kasser. Klik på en kasse for at se midtpunktets MGRS-koordinat
        og bestil satellitbilledet for området. Bestilte kasser bliver automatisk udskiftet
        med et eksempel på det bestilte satellitbillede.
    </p>
</div>

<div class="layout">
    <section class="map-shell" aria-label="Interaktivt Danmarkskort med MGRS-kasser">
        <div class="map-legend">
            <div class="legend-item">
                <span class="legend-swatch pending"></span>
                <span>Ikke bestilt (viser styliseret kortlag)</span>
            </div>
            <div class="legend-item">
                <span class="legend-swatch ordered"></span>
                <span>Bestilt (viser satellitbilledet)</span>
            </div>
        </div>

        <div class="mgrs-map" role="grid" aria-label="MGRS 5x5 km gitter for Danmark">
            @foreach (var tile in Tiles)
            {
                var isOrdered = OrderedTiles.Contains(tile.Code);
                var selected = tile.Code == SelectedTile?.Code;
                <button class="mgrs-cell @(isOrdered ? "ordered" : "pending") @(selected ? "selected" : string.Empty)"
                        style="grid-column: @(tile.Column + 1); grid-row: @(tile.Row + 1);"
                        role="gridcell"
                        aria-pressed="@(selected.ToString().ToLower())"
                        @onclick="() => SelectTile(tile)">
                    <div class="mgrs-label">@tile.Code</div>
                    <div class="mgrs-region">@tile.Region</div>
                    @if (!isOrdered)
                    {
                        <span class="status-pill">Klik for at bestille</span>
                    }
                    else
                    {
                        <span class="status-pill ordered-pill">Billede bestilt</span>
                    }
                </button>
            }
        </div>
    </section>

    <section class="details" aria-live="polite">
        @if (SelectedTile is null)
        {
            <div class="empty-state">
                <h3>Vælg en kasse</h3>
                <p>Marker et MGRS-felt på kortet for at se koordinaterne og bestille et satellitbillede.</p>
            </div>
        }
        else
        {
            var isOrdered = OrderedTiles.Contains(SelectedTile.Code);
            <div class="card">
                <div class="card-header">
                    <div>
                        <p class="eyebrow">5x5 km MGRS kasse</p>
                        <h3>@SelectedTile.Region</h3>
                        <p class="mgrs-code">@SelectedTile.Code</p>
                    </div>
                    <div class="chip @(isOrdered ? "chip-ordered" : "chip-pending")">
                        @(isOrdered ? "Satellitbillede bestilt" : "Ikke bestilt")
                    </div>
                </div>

                <div class="card-body">
                    <p>
                        Midtpunktets koordinat anvendes ved bestilling: <strong>@SelectedTile.CenterCoordinate</strong>.
                        Felterne er placeret i en forsimplet Danmarkskonfiguration, så du hurtigt kan afprøve
                        bestillingsflowet.
                    </p>

                    <div class="preview">
                        <div class="preview-image @(isOrdered ? "" : "preview-placeholder")"
                             style="background-image: url('@(isOrdered ? SatellitePreviewPath : MapTexturePath)');">
                        </div>
                        <div class="preview-text">
                            <p><strong>Region:</strong> @SelectedTile.Region</p>
                            <p><strong>Grid-størrelse:</strong> 5 km x 5 km</p>
                            <p><strong>Midtpunkt (MGRS):</strong> @SelectedTile.Code</p>
                        </div>
                    </div>
                </div>

                <div class="card-actions">
                    <button class="action-button" @onclick="OrderSelectedTile" disabled="@isOrdered">
                        @(isOrdered ? "Billede bestilt" : "Bestil satellitbillede")
                    </button>
                </div>
            </div>
        }
    </section>
</div>

@code {
    private record MgrsTile(string Code, string Region, int Row, int Column, string CenterCoordinate);

    private List<MgrsTile> Tiles { get; } = new()
    {
        new("32VNM 38600 71450", "Skagen/Nordjylland", 0, 3, "57.73°N, 10.60°E"),
        new("32VNL 35250 69750", "Hirtshals", 1, 2, "57.59°N, 10.22°E"),
        new("32VNL 41250 69250", "Frederikshavn", 1, 3, "57.48°N, 10.53°E"),
        new("32VNK 32500 67500", "Thy", 2, 2, "57.00°N, 9.12°E"),
        new("32VNK 40250 66875", "Aalborg", 2, 3, "57.04°N, 9.92°E"),
        new("32VNK 45750 66000", "Himmerland", 2, 4, "56.93°N, 10.30°E"),
        new("32VMK 33250 64250", "Midtjylland", 3, 2, "56.40°N, 9.05°E"),
        new("32VMK 39750 63250", "Viborg", 3, 3, "56.45°N, 9.42°E"),
        new("32VNL 44500 63750", "Djursland", 3, 4, "56.40°N, 10.70°E"),
        new("32VMJ 35000 61750", "Vestjylland", 4, 2, "56.10°N, 8.60°E"),
        new("32VML 40500 61250", "Aarhus", 4, 3, "56.17°N, 10.20°E"),
        new("32VML 47000 60375", "Randers", 4, 4, "56.45°N, 10.05°E"),
        new("32VMJ 34250 59250", "Horsens", 5, 2, "55.86°N, 9.85°E"),
        new("32VML 43250 59250", "Fyn", 5, 3, "55.38°N, 10.33°E"),
        new("32VML 49500 58500", "Sjælland", 5, 4, "55.61°N, 11.43°E"),
        new("32VMK 33250 56750", "Sønderjylland", 6, 2, "55.25°N, 9.20°E"),
        new("32VML 40000 56500", "Storebælt", 6, 3, "55.32°N, 10.90°E"),
        new("33UMV 05500 57000", "København/Nordsjælland", 6, 5, "55.68°N, 12.57°E"),
        new("33UMU 02250 54500", "Lolland/Falster", 7, 4, "54.75°N, 11.60°E"),
        new("32VMG 31000 52500", "Sydjylland", 7, 1, "54.95°N, 8.90°E"),
        new("32VMH 36000 52000", "Als", 7, 2, "54.90°N, 9.80°E")
    };

    private HashSet<string> OrderedTiles { get; } = new();

    private MgrsTile? SelectedTile { get; set; }

    private const string SatellitePreviewPath = "images/sample-satellite.svg";
    private const string MapTexturePath = "images/denmark-outline.svg";

    private void SelectTile(MgrsTile tile)
    {
        SelectedTile = tile;
    }

    private void OrderSelectedTile()
    {
        if (SelectedTile is null)
        {
            return;
        }

        if (!OrderedTiles.Contains(SelectedTile.Code))
        {
            OrderedTiles.Add(SelectedTile.Code);
        }
    }
}
