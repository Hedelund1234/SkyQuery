@page "/mgrs-kort"
@using SkyQuery.Website.Interfaces
@inject IJSRuntime JS
@inject IImageService ImageService
@inject Blazored.LocalStorage.ILocalStorageService LocalStorage
@implements IAsyncDisposable

<PageTitle>MGRS Danmarkskort</PageTitle>

<div class="page-header">
    <h1>Interaktivt MGRS-kort over Danmark</h1>
    <p class="lead">
        Kortet nedenfor bruger et rigtigt baggrundskort over Danmark og viser en 5 km x 5 km MGRS-opdeling. Klik på en kasse for
        at se midtpunktets MGRS-koordinat og bestil satellitbilledet for området.
    </p>
</div>

<div class="layout">
    <section class="map-shell" aria-label="Interaktivt Danmarkskort med MGRS-kasser">
        <div class="map-legend">
            <div class="legend-item">
                <span class="legend-swatch pending"></span>
                <span>Ikke bestilt</span>
            </div>
            <div class="legend-item">
                <span class="legend-swatch ordered"></span>
                <span>Bestilt satellitbillede</span>
            </div>
        </div>

        <div id="mgrsMap" class="mgrs-map" role="application" aria-label="Danmarkskort med MGRS gitter"></div>
        <small class="map-caption">Baggrundskort fra OpenStreetMap | Grid-størrelse: 5 km x 5 km</small>
    </section>

    <section class="details" aria-live="polite">
        @if (SelectedTile is null)
        {
            <div class="empty-state">
                <h3>Vælg en MGRS-kasse</h3>
                <p>Tryk på en af kasserne på kortet for at se midtpunktets MGRS-koordinat.</p>
            </div>
        }
        else
        {
            var isOrdered = OrderedTiles.Contains(SelectedTile.MgrsCode);
            <div class="card">
                <div class="card-header">
                    <div>
                        <p class="eyebrow">5x5 km MGRS kasse</p>
                        <h3>Række @(SelectedTile.Row + 1), Kolonne @(SelectedTile.Column + 1)</h3>
                        <p class="mgrs-code">@SelectedTile.MgrsCode</p>
                    </div>
                    <div class="chip @(isOrdered ? "chip-ordered" : "chip-pending")">
                        @(isOrdered ? "Satellitbillede bestilt" : "Ikke bestilt")
                    </div>
                </div>

                <div class="card-body">
                    <p>
                        Midtpunktets MGRS-koordinat er <strong>@SelectedTile.MgrsCode</strong> og svarer til
                        lat/lon <strong>@SelectedTile.CenterLat.ToString("F5")°N, @SelectedTile.CenterLon.ToString("F5")°E</strong>.
                        Gridet er genereret i 5 km intervaller over Danmarks faktiske udbredelse med OpenStreetMap som baggrund.
                    </p>

                    <div class="preview">
                        <div class="preview-text">
                            <p><strong>Zone/band:</strong> @SelectedTile.ZoneBand</p>
                            <p><strong>Midtpunkt:</strong> @SelectedTile.CenterLat.ToString("F5")°N, @SelectedTile.CenterLon.ToString("F5")°E</p>
                            <p><strong>Grid-størrelse:</strong> 5 km x 5 km</p>
                            <p><strong>Række/Kolonne:</strong> @(SelectedTile.Row + 1) / @(SelectedTile.Column + 1)</p>
                        </div>
                        <div class="preview-image @(isOrdered ? string.Empty : "preview-placeholder")"></div>
                    </div>
                </div>

                <div class="card-actions">
                    <button class="action-button" @onclick="OrderSelectedTile" disabled="@isOrdered">
                        @(isOrdered ? "Billede bestilt" : "Bestil satellitbillede")
                    </button>
                </div>

                @if (!string.IsNullOrWhiteSpace(ActionMessage))
                {
                    <div class="alert @(ActionSuccess ? "alert-success" : "alert-danger")" role="status">
                        @ActionMessage
                    </div>
                }
            </div>
        }
    </section>
</div>

@code {
    public record MgrsSelection(string MgrsCode, double CenterLat, double CenterLon, int Row, int Column, string ZoneBand);

    private DotNetObjectReference<MgrsMap>? _dotNetRef;
    private IJSObjectReference? _module;

    private readonly HashSet<string> OrderedTiles = new();
    private MgrsSelection? SelectedTile { get; set; }
    private string? ActionMessage { get; set; }
    private bool ActionSuccess { get; set; }

    private const double MinLat = 54.56;
    private const double MaxLat = 57.80;
    private const double MinLon = 7.90;
    private const double MaxLon = 13.05;
    private const int CellSizeMeters = 5000;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender)
        {
            return;
        }

        _module = await JS.InvokeAsync<IJSObjectReference>("import", "./js/mgrsMap.js");
        _dotNetRef = DotNetObjectReference.Create(this);
        await _module.InvokeVoidAsync(
            "MgrsMap.init",
            "mgrsMap",
            _dotNetRef,
            new { minLat = MinLat, maxLat = MaxLat, minLon = MinLon, maxLon = MaxLon, cellSizeMeters = CellSizeMeters },
            OrderedTiles.ToList());
    }

    [JSInvokable]
    public Task NotifyTileSelected(MgrsSelection selection)
    {
        SelectedTile = selection;
        ActionMessage = null;
        return InvokeAsync(StateHasChanged);
    }

    private async Task OrderSelectedTile()
    {
        if (SelectedTile is null || _module is null)
        {
            return;
        }

        try
        {
            var userId = await GetUserId();
            await ImageService.OrderImage(userId, SelectedTile.MgrsCode);

            if (OrderedTiles.Add(SelectedTile.MgrsCode))
            {
                await _module.InvokeVoidAsync("MgrsMap.markOrdered", SelectedTile.MgrsCode);
            }

            ActionSuccess = true;
            ActionMessage = $"✅ Billede bestilt for {SelectedTile.MgrsCode}";
        }
        catch (Exception ex)
        {
            ActionSuccess = false;
            ActionMessage = $"❌ Kunne ikke bestille: {ex.Message}";
        }

        await InvokeAsync(StateHasChanged);
    }

    private async Task<string> GetUserId()
    {
        var raw = await LocalStorage.GetItemAsStringAsync("authToken");
        if (string.IsNullOrWhiteSpace(raw))
        {
            throw new InvalidOperationException("Auth token not found");
        }

        string token;
        try
        {
            token = await LocalStorage.GetItemAsStringAsync("authToken") ?? string.Empty;
        }
        catch
        {
            throw new InvalidOperationException("authToken is not valid");
        }

        var handler = new System.IdentityModel.Tokens.Jwt.JwtSecurityTokenHandler();
        var jwt = handler.ReadJwtToken(token);

        var userId = jwt.Claims
            .FirstOrDefault(c =>
                c.Type == "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/nameidentifier" ||
                c.Type == System.Security.Claims.ClaimTypes.NameIdentifier)
            ?.Value;

        if (string.IsNullOrWhiteSpace(userId))
        {
            throw new InvalidOperationException("UserId claim not found in token");
        }

        return userId;
    }

    public async ValueTask DisposeAsync()
    {
        if (_module is not null)
        {
            try
            {
                await _module.InvokeVoidAsync("MgrsMap.dispose", "mgrsMap");
            }
            catch
            {
                // ignorer oprydningsfejl
            }
        }

        _dotNetRef?.Dispose();
    }
}
