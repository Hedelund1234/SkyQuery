@page "/mgrs-kort"

<PageTitle>MGRS Danmarkskort</PageTitle>

<div class="page-header">
    <h1>Interaktivt MGRS-kort over Danmark</h1>
    <p class="lead">
        Hele Danmark er opdelt i 5 km x 5 km felter, der følger MGRS. Klik på et felt for at se midtpunktets
        MGRS-koordinat og bestil satellitbilledet for den valgte kasse. Bestilte felter skifter fra kortvisning til
        satellitbillede.
    </p>
</div>

<div class="layout">
    <section class="map-shell" aria-label="Interaktivt Danmarkskort med MGRS-kasser">
        <div class="map-legend">
            <div class="legend-item">
                <span class="legend-swatch pending"></span>
                <span>Ikke bestilt (kortbaggrund)</span>
            </div>
            <div class="legend-item">
                <span class="legend-swatch ordered"></span>
                <span>Bestilt (viser satellitbillede)</span>
            </div>
        </div>

        <div class="mgrs-map" role="grid" aria-label="MGRS 5x5 km gitter for Danmark" style="--cols:@GridColumns; --rows:@GridRows;">
            @foreach (var tile in Tiles)
            {
                var isOrdered = OrderedTiles.Contains(tile.Code);
                var selected = tile.Code == SelectedTile?.Code;
                <button class="mgrs-cell @(isOrdered ? "ordered" : "pending") @(selected ? "selected" : string.Empty)"
                        style="grid-column: @(tile.Column + 1); grid-row: @(tile.Row + 1);"
                        role="gridcell"
                        aria-pressed="@(selected.ToString().ToLower())"
                        @onclick="() => SelectTile(tile)">
                    <div class="mgrs-label">@tile.Code</div>
                    <div class="mgrs-region">Midtpunkt: @tile.CenterLatLon</div>
                    <span class="status-pill @(isOrdered ? "ordered-pill" : string.Empty)">@(isOrdered ? "Billede bestilt" : "Klik for at bestille")</span>
                </button>
            }
        </div>
    </section>

    <section class="details" aria-live="polite">
        @if (SelectedTile is null)
        {
            <div class="empty-state">
                <h3>Vælg en MGRS-kasse</h3>
                <p>Tryk på et felt for at se MGRS-koordinatet i centrum og bestille satellitbilledet.</p>
            </div>
        }
        else
        {
            var isOrdered = OrderedTiles.Contains(SelectedTile.Code);
            <div class="card">
                <div class="card-header">
                    <div>
                        <p class="eyebrow">5x5 km MGRS kasse</p>
                        <h3>@SelectedTile.Region</h3>
                        <p class="mgrs-code">@SelectedTile.Code</p>
                    </div>
                    <div class="chip @(isOrdered ? "chip-ordered" : "chip-pending")">
                        @(isOrdered ? "Satellitbillede bestilt" : "Ikke bestilt")
                    </div>
                </div>

                <div class="card-body">
                    <p>
                        Midtpunktets MGRS-koordinat er <strong>@SelectedTile.Code</strong> og svarer til
                        lat/lon <strong>@SelectedTile.CenterLatLon</strong>. Felterne er genereret i 5 km intervaller
                        hen over Danmark med zoneopdeling mellem 32V og 33U.
                    </p>

                    <div class="preview">
                        <div class="preview-image @(isOrdered ? string.Empty : "preview-placeholder")"
                             style="background-image: url('@(isOrdered ? SatellitePreviewPath : MapTexturePath)');">
                        </div>
                        <div class="preview-text">
                            <p><strong>Zone:</strong> @SelectedTile.ZoneBand</p>
                            <p><strong>Grid-størrelse:</strong> 5 km x 5 km</p>
                            <p><strong>Kolonne/række:</strong> @(SelectedTile.Column + 1) / @(SelectedTile.Row + 1)</p>
                        </div>
                    </div>
                </div>

                <div class="card-actions">
                    <button class="action-button" @onclick="OrderSelectedTile" disabled="@isOrdered">
                        @(isOrdered ? "Billede bestilt" : "Bestil satellitbillede")
                    </button>
                </div>
            </div>
        }
    </section>
</div>

@code {
    private record MgrsTile(string Code, string Region, int Row, int Column, string CenterLatLon, string ZoneBand);

    private const int GridColumns = 16;
    private const int GridRows = 12;
    private const int GridSizeMeters = 5000;
    private const int EastingStart = 300_000; // Vestlig start i UTM zone 32V
    private const int NorthingStart = 6_240_000; // Nordlig start omkring Danmark
    private const double MaxLatitude = 57.85;
    private const double MinLatitude = 54.56;
    private const double WestLongitude = 7.90;
    private const double EastLongitude = 13.05;

    private readonly List<MgrsTile> Tiles = new();
    private readonly HashSet<string> OrderedTiles = new();

    private MgrsTile? SelectedTile { get; set; }

    private const string SatellitePreviewPath = "images/sample-satellite.svg";
    private const string MapTexturePath = "images/denmark-outline.svg";

    protected override void OnInitialized()
    {
        GenerateTiles();
    }

    private void GenerateTiles()
    {
        Tiles.Clear();

        var latStep = (MaxLatitude - MinLatitude) / GridRows;
        var lonStep = (EastLongitude - WestLongitude) / GridColumns;

        for (var row = 0; row < GridRows; row++)
        {
            for (var col = 0; col < GridColumns; col++)
            {
                var centerLat = MaxLatitude - (row + 0.5) * latStep;
                var centerLon = WestLongitude + (col + 0.5) * lonStep;
                var zone = centerLon >= 12.0 ? 33 : 32;
                var band = GetLatBand(centerLat);
                var squareId = GetSquareId(row, col);

                var easting = EastingStart + (col * GridSizeMeters);
                var northing = NorthingStart - (row * GridSizeMeters);

                var mgrs = $"{zone}{band}{squareId} {easting:D5} {northing:D5}";
                var region = $"Felt {row + 1}-{col + 1}";
                var latLonText = $"{centerLat:F4}°N, {centerLon:F4}°E";

                Tiles.Add(new MgrsTile(mgrs, region, row, col, latLonText, $"{zone}{band}"));
            }
        }
    }

    private static string GetLatBand(double latitude)
    {
        // MGRS lat bands: U covers 48-56, V covers 56-64 for N hemisphere
        return latitude >= 56.0 ? "V" : "U";
    }

    private static string GetSquareId(int row, int column)
    {
        const string letters = "ABCDEFGHJKLMNPQRSTUVWXYZ"; // uden I og O
        var first = letters[(column * 3 + row) % letters.Length];
        var second = letters[(column * 5 + row * 2) % letters.Length];
        return $"{first}{second}";
    }

    private void SelectTile(MgrsTile tile)
    {
        SelectedTile = tile;
    }

    private void OrderSelectedTile()
    {
        if (SelectedTile is null)
        {
            return;
        }

        if (OrderedTiles.Add(SelectedTile.Code))
        {
            StateHasChanged();
        }
    }
}
