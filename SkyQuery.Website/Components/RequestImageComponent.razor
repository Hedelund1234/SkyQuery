@using SkyQuery.Website.Interfaces
@using System.IdentityModel.Tokens.Jwt
@using System.Security.Claims
@inject IImageService ImageService
@inject Blazored.LocalStorage.ILocalStorageService localStorageService

<h3>Request Image</h3>

<div class="mb-3">
    <label class="form-label" for="mgrsInput">MGRS</label>
    <input id="mgrsInput"
           class="form-control"
           @bind="Mgrs"
           placeholder="Indtast MGRS (fx 32V MN 1234 5678)" />
</div>

<div class="d-flex gap-2">
    <button class="btn btn-success" @onclick="OnBestil">
        Bestil
    </button>

    <button class="btn btn-primary" @onclick="OnHent">
        Hent
    </button>
</div>

@if (!string.IsNullOrWhiteSpace(LastAction))
{
    <div class="alert alert-info mt-3">@LastAction</div>
}

@if (!string.IsNullOrWhiteSpace(imageDataUrl))
{
    <img src="@imageDataUrl" alt="Billede" class="preview-image" />
}


@code {
    // f4a0c594-4467-4c36-9e18-bf77c1dc5fb5
    // 32UNG 3158 5027
    private string UserId { get; set; } = string.Empty;
    private string Mgrs { get; set; } = string.Empty;

    private string? imageDataUrl;

    private string? LastAction;

    private async Task OnBestil()
    {
        try
        {
            UserId = await GetUserID();
            if (UserId == "" || Mgrs == "" || UserId is null)
            {
                LastAction = "❌ UserId eller Mgrs er tom";
                return;
            }
            await ImageService.OrderImage(UserId, Mgrs);
            LastAction = "✅ Bestilling sendt!";
        }
        catch (Exception ex)
        {
            LastAction = $"❌ Fejl: {ex.Message}";
        }
        StateHasChanged();
    }

    private async Task OnHent()
    {
        try
        {
            UserId = await GetUserID();
            if (UserId == "" || Mgrs == "" || UserId is null)
            {
                LastAction = "❌ UserId eller Mgrs er tom";
                return;
            }
            var bytes = await ImageService.GetImageAsync(UserId, Mgrs);
            imageDataUrl = $"data:image/png;base64,{Convert.ToBase64String(bytes)}";
        }
        catch (Exception ex)
        {
            LastAction = $"❌ Billede ikke fundet. Har du bestilt det? MESSAGE: {ex.Message}"; 
        }

        StateHasChanged();
    }

    private async Task<string> GetUserID()
    {
        // 1. Hent token fra local storage
        var raw = await localStorageService.GetItemAsStringAsync("authToken");
        if (string.IsNullOrWhiteSpace(raw))
        {
            throw new Exception("Auth token not found");
        }

        string? token;
        try
        {
            token = await localStorageService.GetItemAsStringAsync("authToken");
        }
        catch
        {
            throw new Exception("authToken is not valid JSON or missing 'token' property");
        }

        // 2. Parse JWT
        var handler = new JwtSecurityTokenHandler();
        var jwt = handler.ReadJwtToken(token);

        var userId = jwt.Claims
            .FirstOrDefault(c =>
                c.Type == "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/nameidentifier" ||
                c.Type == ClaimTypes.NameIdentifier)
            ?.Value;

        if (userId is null)
        {
            throw new Exception("UserId claim not found in token");
        }
        else
        {
            return userId;
        }
    }
}